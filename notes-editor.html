<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Notes Editor ‚Äî –∑–∞–ø–∏—Å—å –≤ –ø–∞–ø–∫—É notes</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:980px;margin:28px auto;padding:0 16px;color:#111}
h1{font-size:20px;margin-bottom:6px}
.row{display:flex;gap:12px;align-items:center}
button{padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#f5f5f5;cursor:pointer}
button.primary{background:#0078d4;color:#fff;border-color:#0063b1}
input[type="text"]{padding:8px;border:1px solid #ccc;border-radius:6px;width:220px}
textarea{width:100%;height:220px;padding:10px;border:1px solid #ccc;border-radius:6px;font-family:monospace}
.panel{background:#fff;padding:12px;border-radius:8px;border:1px solid #eee;box-shadow:0 1px 0 rgba(0,0,0,0.02);}
.files{max-height:300px;overflow:auto;border:1px dashed #ddd;padding:8px;border-radius:6px}
.file-item{display:flex;justify-content:space-between;padding:6px 8px;border-bottom:1px solid #f0f0f0}
.muted{color:#666;font-size:13px}
small{color:#666}
.danger{background:#ffe9e9;border-color:#f1a6a6}
</style>
</head>
<body>
<h1>Notes Editor ‚Äî –∑–∞–ø–∏—Å—å/—á—Ç–µ–Ω–∏–µ .txt –≤ –ø–∞–ø–∫—É <code>notes</code></h1>
<p class="muted">–†–∞–±–æ—Ç–∞–µ—Ç –≤ Chrome/Edge. –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–µ–Ω—å —Å–∞–π—Ç–∞, –≤–Ω—É—Ç—Ä–∏ –∫–æ—Ç–æ—Ä–æ–≥–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞ <code>notes</code>.</p>

<div class="panel">
  <div class="row" style="margin-bottom:10px">
    <button id="btnChooseRoot">üìÅ –í—ã–±—Ä–∞—Ç—å –∫–æ—Ä–µ–Ω—å —Å–∞–π—Ç–∞</button>
    <span id="dirName" style="margin-left:12px" class="muted">–ü–∞–ø–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</span>
  </div>

  <div style="display:flex;gap:12px;margin-bottom:10px;flex-wrap:wrap">
    <input id="newFilename" type="text" placeholder="–∏–º—è —Ñ–∞–π–ª–∞ (–±–µ–∑ .txt)">
    <button id="btnNew" class="primary" disabled>‚ûï –°–æ–∑–¥–∞—Ç—å/–û—Ç–∫—Ä—ã—Ç—å</button>
  </div>

  <div style="display:flex;gap:12px;align-items:flex-start">
    <div style="flex:1">
      <div class="muted" style="margin-bottom:6px">–°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ (.txt)</div>
      <div id="filesList" class="files"><div class="muted">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–µ–Ω—å —Å–∞–π—Ç–∞</div></div>
    </div>

    <div style="flex:2">
      <div class="muted" style="margin-bottom:6px">–†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞</div>
      <div id="editorPanel">
        <div style="margin-bottom:8px" id="currentMeta"><small>–§–∞–π–ª: ‚Äî</small></div>
        <textarea id="editor" placeholder="–û—Ç–∫—Ä–æ–π—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª..." disabled></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnSave" class="primary" disabled>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button id="btnDelete" class="danger" disabled>üóë –£–¥–∞–ª–∏—Ç—å</button>
          <button id="btnDownload" disabled>‚¨á –°–∫–∞—á–∞—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <div style="margin-top:10px" class="muted">
    –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∫–æ—Ä–Ω—è –≤—Å–µ —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∏ —á–∏—Ç–∞—é—Ç—Å—è –≤ –ø–∞–ø–∫–µ <code>notes</code>.
  </div>
</div>

<script>
const btnChooseRoot = document.getElementById('btnChooseRoot');
const dirNameEl = document.getElementById('dirName');
const filesList = document.getElementById('filesList');
const newFilename = document.getElementById('newFilename');
const btnNew = document.getElementById('btnNew');
const editor = document.getElementById('editor');
const currentMeta = document.getElementById('currentMeta');
const btnSave = document.getElementById('btnSave');
const btnDelete = document.getElementById('btnDelete');
const btnDownload = document.getElementById('btnDownload');

let rootHandle = null;
let notesDir = null;
let currentFileHandle = null;
let currentFilename = null;

const supportsFS = !!window.showDirectoryPicker;

function setEditorState(enabled){
  editor.disabled = !enabled;
  btnSave.disabled = !enabled;
  btnDelete.disabled = !enabled;
  btnDownload.disabled = !enabled;
  btnNew.disabled = !enabled;
}

setEditorState(false);

btnChooseRoot.addEventListener('click', async ()=>{
  if(!supportsFS){ alert('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome/Edge'); return; }
  try{
    rootHandle = await window.showDirectoryPicker();
    dirNameEl.textContent = '–ö–æ—Ä–µ–Ω—å –≤—ã–±—Ä–∞–Ω: ' + rootHandle.name;
    
    // –ø–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É notes
    notesDir = await rootHandle.getDirectoryHandle('notes', {create:true});
    
    await refreshFileList();
    setEditorState(true);
  }catch(err){
    console.error(err);
    alert('–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–æ—Ä–Ω—è: '+err.message);
  }
});

async function refreshFileList(){
  if(!notesDir){ 
    filesList.innerHTML='<div class="muted">–ü–∞–ø–∫–∞ notes –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>'; 
    return; 
  }
  filesList.innerHTML='';
  const items=[];
  for await(const [name, handle] of notesDir.entries()){
    if(handle.kind==='file' && name.toLowerCase().endsWith('.txt')){
      items.push({name, handle});
    }
  }
  if(items.length===0){
    filesList.innerHTML='<div class="muted">–§–∞–π–ª–æ–≤ .txt –Ω–µ—Ç</div>';
  }else{
    items.sort((a,b)=>a.name.localeCompare(b.name));
    for(const it of items){
      const row=document.createElement('div');
      row.className='file-item';
      const title=document.createElement('div');
      title.textContent=it.name;
      title.style.cursor='pointer';
      title.addEventListener('click', ()=> openFile(it.handle, it.name));
      const delBtn=document.createElement('button');
      delBtn.textContent='–£–¥–∞–ª–∏—Ç—å';
      delBtn.className='danger';
      delBtn.addEventListener('click', ()=> deleteFileConfirm(it.name));
      row.appendChild(title);
      row.appendChild(delBtn);
      filesList.appendChild(row);
    }
  }
  updateEditorControls();
}

btnNew.addEventListener('click', async ()=>{
  const nameRaw = newFilename.value.trim();
  if(!nameRaw){ alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞'); return; }
  const filename = nameRaw.endsWith('.txt') ? nameRaw : nameRaw+'.txt';
  try{
    // —Å–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª –≤ notesDir
    currentFileHandle = await notesDir.getFileHandle(filename,{create:true});
    currentFilename = filename;

    const file = await currentFileHandle.getFile();
    editor.value = await file.text();
    currentMeta.innerHTML=`<small>–§–∞–π–ª: <strong>${currentFilename}</strong></small>`;

    setEditorState(true);

    // –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ notesDir
    await refreshFileList();
  }catch(err){ 
    console.error(err); 
    alert('–û—à–∏–±–∫–∞: '+err.message); 
  }
});

async function openFile(handle, name){
  try{
    currentFileHandle = handle;
    currentFilename = name;
    const file = await handle.getFile();
    editor.value = await file.text();
    currentMeta.innerHTML=`<small>–§–∞–π–ª: <strong>${currentFilename}</strong></small>`;
    setEditorState(true);
  }catch(err){ 
    console.error(err); 
    alert('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è: '+err.message); 
  }
}

btnSave.addEventListener('click', async ()=>{
  if(!currentFileHandle){ alert('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω'); return; }
  try{
    const writable = await currentFileHandle.createWritable();
    await writable.write(editor.value);
    await writable.close();
    alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ');
    await refreshFileList();
  }catch(err){ 
    console.error(err); 
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: '+err.message); 
  }
});

btnDelete.addEventListener('click', async ()=>{
  if(!currentFilename) return;
  if(!confirm('–£–¥–∞–ª–∏—Ç—å '+currentFilename+' ?')) return;
  try{
    await notesDir.removeEntry(currentFilename);
    if(currentFilename){
      currentFileHandle=null;
      currentFilename=null;
      editor.value='';
      currentMeta.innerHTML='<small>–§–∞–π–ª: ‚Äî</small>';
      setEditorState(false);
    }
    await refreshFileList();
  }catch(err){ 
    console.error(err); 
    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: '+err.message); 
  }
});

btnDownload.addEventListener('click', async ()=>{
  if(!currentFileHandle) return;
  try{
    const file = await currentFileHandle.getFile();
    const blob = new Blob([await file.text()], {type:'text/plain'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=currentFilename;
    a.click();
    URL.revokeObjectURL(a.href);
  }catch(err){ 
    console.error(err); 
    alert('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: '+err.message); 
  }
});

function updateEditorControls(){
  if(!currentFileHandle){ setEditorState(false); }
}

async function deleteFileConfirm(filename){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å '+filename+' ?')) return;
  try{
    await notesDir.removeEntry(filename);
    if(currentFilename===filename){
      currentFileHandle=null;
      currentFilename=null;
      editor.value='';
      currentMeta.innerHTML='<small>–§–∞–π–ª: ‚Äî</small>';
      setEditorState(false);
    }
    await refreshFileList();
  }catch(err){ 
    console.error(err); 
    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: '+err.message); 
  }
}
</script>
</body>
</html>
